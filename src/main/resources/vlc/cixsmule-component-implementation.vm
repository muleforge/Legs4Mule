#**
Mule Component Implementation Velocity Template.
@author Fady
@version 0.1
*#
#parse("vlc/cixsmule-component-common-package.vm")
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;

import org.mule.umo.UMOEventContext;
import org.mule.umo.lifecycle.Callable;

import com.legstar.host.invoke.HostInvoker;
import com.legstar.host.invoke.HostInvokerException;
import com.legstar.host.invoke.HostInvokerFactory;
import com.legstar.messaging.Address;
#parse("vlc/cixsmule-component-common-imports.vm")

#if ($maps)
import java.util.LinkedHashMap;
import java.util.Map;
import com.legstar.coxb.ICobolComplexBinding;
#end
#foreach($importType in $importTypes)
import ${importType};
#set($bindPackage = ${importType.substring(0, ${importType.lastIndexOf('.')})})
#set($bindType = ${importType.substring(${importType.lastIndexOf('.')}, ${importType.length()})})
import ${bindPackage}.bind${bindType}Binding;
#end
import org.mule.legstar.cixs.invoker.MuleHostHeaderFactory;
import org.mule.legstar.cixs.invoker.CixsMuleException;
## ==================================================================
## Since input and output structures are initialized almost in the
## same way, we use a common macro.
#macro(initStruct $cixsStructures $mode)
            /* Prepare the $mode parameter set using static binding */
#set($pos = 1)
#set($multi = false)
#if ($cixsStructures.size() > 1)#set($multi = true)#end
#if($multi)
            Map <String, ICobolComplexBinding> ${mode}Parts =
              new LinkedHashMap <String, ICobolComplexBinding>(); 
#end
#foreach($cicsStructure in $cixsStructures)
            ${cicsStructure.jaxbType}Binding ${mode}${pos} =
                  new ${cicsStructure.jaxbType}Binding(#if(${mode} == "input")request#if($multi).get(${cicsStructure.jaxbPropertyName})#end#end);
#if($multi)
            inParts.put("${cicsStructure.cicsContainer}", ${mode}${pos});
#end
#set($pos = $pos + 1)
#end ##foreach            
#end
## ==================================================================

/**
 * LegStar/Mule Component implementation.
 * Each method maps to a CICS program. 
 * 
 * This class was generated by ${generatorName}.
 * Generated on $formattedDate
 */
public class $muleComponent.implementationClassName implements ${muleComponent.interfaceClassName}, Callable {

    /** The JNDI locator for the configuration file name.*/
    private static final String JNDI_CONFIG_FILE =
        "java:comp/env/legstar/configFileName";
    
    /** The default configuration file name if not recovered from JNDI. */
    private static final String DEFAULT_CONFIG_FILE = "legstar-invoker-config.xml";

    /** The configuration file name. */
    private String mConfigFileName;

#foreach ($cixsOperation in $muleComponent.cixsOperations)
    /** Properties for operation ${cixsOperation.name}. */
    private static final String ${cixsOperation.name.toUpperCase()}_PROP_FILE = "${cixsOperation.name}.properties";
#end

    /** Lookup the configuration file name at construction time. */
    public ${muleComponent.implementationClassName}() {
        try {
            Context initCtx = new InitialContext();
            mConfigFileName = (String) initCtx.lookup(JNDI_CONFIG_FILE);
        } catch (NamingException e) {
            mConfigFileName = DEFAULT_CONFIG_FILE;
        }
    }

#foreach ($cixsOperation in $muleComponent.cixsOperations)
    /** Synchronous execution of a remote host program. */
    /** {@inheritDoc} */
    public final $cixsOperation.responseHolderType ${cixsOperation.name}(
            $cixsOperation.requestHolderType request,
            MuleHostHeader hostHeader)
        throws ${cixsOperation.faultType} {

        $cixsOperation.responseHolderType reply = null;

        try {
              
            /* Initialize invoker with static data and data from headers */
            HostInvoker mInvoker = HostInvokerFactory.createHostInvoker(
                mConfigFileName, hostHeader.getAddress(), ${cixsOperation.name.toUpperCase()}_PROP_FILE);

#initStruct($cixsOperation.getInput() "input")

#initStruct($cixsOperation.getOutput() "output")

            /* Call remote program */
            mInvoker.invoke(hostHeader.getHostRequestID(),
                    #if($cixsOperation.getInput().size() > 1)inputParts#else input1#end,
                    #if($cixsOperation.getOutput().size() > 1)outputParts#else output1#end);

#if($cixsOperation.getOutput().size() > 1)
            /* Populate response holder with reply objects */
            reply = new ${cixsOperation.responseHolderType}();
#set($pos = 1)
#foreach($cicsStructure in $cixsOperation.getOutput())
            reply.set${cicsStructure.jaxbPropertyName}(output${pos}.get${cicsStructure.jaxbType}());
#set($pos = $pos + 1)
#end ##foreach  
#else
            /* Get reply object */
            reply = output1.get${cixsOperation.getOutput().get(0).jaxbType}();
#end

        } catch (HostInvokerException e) {
            throw new ${cixsOperation.faultType}(e);
        }

        return reply;
    }

#end
    @Override
    public Object onCall(UMOEventContext eventContext) throws Exception {
        MuleHostHeader hostHeader =
            MuleHostHeaderFactory.createHostHeader(eventContext.getMessage());
        Object request  = eventContext.getTransformedMessage();
#foreach ($cixsOperation in $muleComponent.cixsOperations)
        if (request instanceof ${cixsOperation.requestHolderType}) {
            if (hostHeader.getHostRequestID() == null) {
                hostHeader.setHostRequestID("${cixsOperation.name}");
            }
            return ${cixsOperation.name}((${cixsOperation.requestHolderType}) request, hostHeader);
        }
#end
        throw new CixsMuleException("Unrecognized request " + request);
    }

}
